<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>Notes</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="manifest" href="manifest.json">
	<link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80' fill='%238aab55'>üÖê</text></svg>">
	<style>
		:root {
			--col1: #eee4cb;	/*base*/
			--col2: #e0d4b7;	/*background alt*/
			--col3: #d7c7a2;	/*border*/
			--col4: #473e33;	/*text*/
			--col5: color-mix(in srgb, var(--col4), var(--col1) 50%);	/*faint text*/
			--col-accent: #8aab55;	/*accent*/
			--bar-height: 5vh;
			--main-border-radius: 13px;
			--main-margin-width: 10px;
			--window-height: calc(100vh - var(--main-margin-width) * 2);
			--min-height: calc(var(--main-border-radius) * 1.5);
			--input-height: calc(var(--bar-height) - 5px - var(--main-margin-width) * 0.9)
		}
		
		/* Dark theme overrides */
		@media (prefers-color-scheme: dark) {
			:root {
				--col1: #241f1a;	/*base*/
				--col2: #14110d;	/*background alt*/
				--col3: #3b2d24;	/*border*/
				--col4: #cfc0b0;	/*text*/
				--col-accent: color-mix(in srgb, #8aab55 50%, transparent);	/*accent*/
			}
		}
		
		body{
			height: var(--window-height);
			margin: var(--main-margin-width);
		}
		
		.wrap {
			display: flex;
			background-color: var(--col2);
			flex-direction: column;
			justify-content: flex-start;
			font-size: 0.8rem;
			font-family: 'Ubuntu', Arial, sans-serif;
		}
		
		#plaintext {
			height: 100%;
			margin: 0px !important;
			resize:none;
			border-radius: var(--main-border-radius);
			padding: 12px;
			background-color: var(--col1);
			border: 1px solid var(--col3);
			color: var(--col4);
			font-size: 15px;
			line-height: 1.5;
			font-family: 'Ubuntu', Arial, sans-serif;
		}
		
		#plaintext:focus {
			/* outline: none !important; */
			outline: 2px solid var(--col-accent);
		}
		
		.top-bar {
			display: flex;
			flex-direction: row;
			justify-content: flex-end;
			align-items: center;
			height: var(--bar-height);
			min-height: var(--min-height);
			border-radius: var(--main-border-radius);
			margin-bottom: var(--main-margin-width);
			background-color: var(--col1);
		}
		
		.bar-button {
			border: 1px solid var(--col3);
			height: var(--bar-height);
			margin-right: var(--main-margin-width);
			border-radius: var(--main-border-radius);
			background-color: var(--col1);
			color: var(--col4);
			cursor: pointer
		}
		
		.bar-button:active {
			transform: translateY(1px)
		}
		
		.bar-button:hover {
			background-color: var(--col2);
		}
		
		#file-name {
			border: 1px solid var(--col3);
			height: var(--input-height);
			margin-right: var(--main-margin-width);
			border-radius: var(--main-border-radius);
			background-color: var(--col1);
			color: var(--col4);
			width: 15vw;
		}
		
		#file-name:focus {
			outline: 2px solid var(--col-accent);
		}
		
		.counter {
			height: var(--bar-height);
			border-right: 1px solid var(--col3);
			padding-right: var(--main-margin-width);
			margin-right: var(--main-margin-width);
			background-color: var(--col1);
			color: var(--col5);
			height: fit-content;
			width: fit-content;
			flex: 0 0 auto;
		}
		
		.counter-block {
			display: flex;
			justify-content: flex-end;
			align-content: center;
			flex-wrap: nowrap;
			flex-direction: row;
			align-items: center;
			height: 15px;
			overflow: hidden;
		}
	</style>
</head>

<body class="wrap">
	<div class="top-bar">
		<span class="counter-block">
			<span class="counter">1</span>
			<span class="counter">2</span>
			<span class="counter">3</span>
		</span>
		<input id="file-name" placeholder="My Note.txt">
		<input type="button" class="bar-button" value="Export">
		<input type="button" class="bar-button" value="Import">
	</div>
	<textarea id="plaintext" placeholder="type here"></textarea>
	<script>
		const plaintext = document.getElementById('plaintext');
		var timeoutID = null;
		const filenameBox = document.getElementById('file-name');
		
		const controlsContainer = document.querySelector('.top-bar');
		const KEY = 'MyNoteString';
		const [charsEl, wordsEl, linesEl] = document.querySelectorAll('.counter');
		
		if ("Service Worker" in navigator) {
			window.addEventListener("load", () => {
				navigator.serviceWorker.register("/sw.js").then(registration => {console.log("service worker registered", registration.scope);
				}).catch(error => {
					console.log("service worker registration faield", error);
				});
			});
		}
		
		// Autosave to local storage
		plaintext.value = localStorage.getItem(KEY) || '';
		// Placing caret at the end
		plaintext.setSelectionRange(plaintext.value.length, plaintext.value.length);
		// Calculate text stats after load
		calcStats();
		
		function storeLocally() {
			localStorage.setItem(KEY, plaintext.value);
		}
		
		// Save before closing?
		window.beforeunload = storeLocally;
		
		plaintext.onkeyup = function () {
			// Calculate text stats
			calcStats();
			// Auto-save to local storage (at most once per second)
			window.clearTimeout(timeoutID);
			timeoutID = window.setTimeout(storeLocally, 1000);
		}
		
		function exportFile () {
			const a = document.createElement('a');
			a.href = URL.createObjectURL(new Blob([plaintext.value], { type: 'text/plain' }));
			a.download = (filenameBox.value || 'My Note.txt').replace(/^([^.]*)$/, "$1.txt");
			document.body.appendChild(a);
			console.log(a.href);
			a.click();
			// URL.revokeObjectURL(a.href);
			a.remove();
			// Revoke url with a delay
			setTimeout(() => URL.revokeObjectURL(a.href), 5000);
		}
		
		function importFile () {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.txt,.md,text/plain';
			input.onchange = () => {
				const file = input.files[0];
				if (!file) return;
				const reader = new FileReader();
				reader.onload = () => {
					filenameBox.value = file.name;
					plaintext.value = reader.result;
				}
				reader.onerror = () => console.error('Read error', reader.error);
				reader.readAsText(file, 'utf-8');
			};
			input.click();
			input.remove();
		}
		
		function calcStats () {
			console.log('calcStats called')
			charsEl.textContent = plaintext.value.length + ' characters';
			wordsEl.textContent = plaintext.value === "" ? 0 : plaintext.value.replace(/\s+/g, ' ').split(' ').length + ' words';
			linesEl.textContent = plaintext.value.split(/\n/).length + ' lines';
		}
		
		//Event listener for buttons
		controlsContainer.addEventListener("click", (event) => {
			// Check which button is pressed here
			if (event.target.className === "bar-button") {
				if (event.target.value === "Export") {
					console.log(event.target.value + ' is clicked');
					exportFile();
					event.stopPropagation();
				}
				if (event.target.value === "Import") {
					console.log(event.target.value + ' is clicked');
					importFile();
					event.stopPropagation();
				}
			}
		})
	</script>
</body>
